<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | Aura</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --rose-dark: #D8A9A6; 
            --rose-light: #fdf2f0;
            --bg-body: #f4f7f6; 
            --white: #ffffff;
            --text-main: #2c3e50; 
            --danger: #e74c3c; 
            --success: #27ae60; 
            --vip-gold: linear-gradient(135deg, #d4af37 0%, #f9e29c 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg-body); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* SIDEBAR */
        .sidebar { 
            width: 260px; background: var(--white); display: flex; flex-direction: column; 
            padding: 2rem 1.5rem; border-right: 1px solid #eee; flex-shrink: 0;
        }
        .brand { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 3rem; text-align: center; }
        .menu a { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            color: #666; text-decoration: none; border-radius: 10px; margin-bottom: 5px; cursor: pointer; transition: 0.3s;
        }
        .menu a:hover { background: #fafafa; }
        .menu a.active { background: var(--rose-light); color: var(--rose-dark); font-weight: 600; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; background: #f8fafb; }
        
        /* CARDS & TABLES */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card-stat { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; align-items: center; gap: 15px; }
        .card-vip { background: var(--vip-gold) !important; color: #5c4b00; border: 1px solid #c5a028; }
        
        .panel { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 12px; color: #999; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #eee; }
        td { padding: 12px; font-size: 0.85rem; border-bottom: 1px solid #f9f9f9; color: #444; }

        /* BADGES */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #eafbf0; color: var(--success); }
        .status-blocked { background: #fdeaea; color: var(--danger); }

        .product-thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }

        /* MODAIS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; padding: 2rem; border-radius: 15px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Montserrat', sans-serif; }
        .btn-primary { background: var(--rose-dark); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        /* --- TOAST NOTIFICATIONS (NOVO) --- */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            background: white; min-width: 300px; padding: 15px 20px; border-radius: 8px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 15px;
            animation: slideInLeft 0.5s ease forwards; border-left: 5px solid #ccc;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--rose-dark); }
        .toast-content h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .toast-content p { font-size: 0.8rem; color: #666; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(50px); } }

        /* --- CHAT NO ADMIN --- */
        .ticket-item { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; transition: 0.2s; }
        .ticket-item:hover { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .ticket-item.new-msg { border-left-color: var(--rose-dark); background: #fff5f5; }
        
        .chat-history { height: 300px; overflow-y: auto; background: #f4f7f6; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #eee; }
        .admin-msg { align-self: flex-end; background: var(--rose-dark); color: white; padding: 8px 12px; border-radius: 12px 12px 0 12px; max-width: 80%; font-size: 0.9rem; }
        .client-msg { align-self: flex-start; background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 12px 12px 12px 0; max-width: 80%; font-size: 0.9rem; }
        .sys-msg { align-self: center; font-size: 0.75rem; color: #999; margin: 5px 0; font-style: italic; }

    </style>
</head>
<body>

    <div class="toast-container" id="toast-container"></div>

    <div class="sidebar">
        <div class="brand">Aura<span>.</span></div>
        <nav class="menu">
            <a onclick="switchTab('clients')" id="menu-clients" class="active"><i class="fas fa-users"></i> Clientes</a>
            <a onclick="switchTab('products')" id="menu-products"><i class="fas fa-boxes"></i> Estoque</a>
            <a onclick="switchTab('support')" id="menu-support"><i class="fas fa-comments"></i> Suporte <span id="support-badge" style="background:var(--danger); color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; margin-left:auto; display:none">!</span></a>
            <a href="index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Loja</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="view-clients" class="view-section active">
            <div class="stats-grid">
                <div class="card-stat">
                    <i class="fas fa-user-friends fa-2x" style="color:var(--rose-dark)"></i>
                    <div><h3 id="count-clients">0</h3><p>Total Clientes</p></div>
                </div>
                <div class="card-stat card-vip">
                    <i class="fas fa-crown fa-2x"></i>
                    <div><h3 id="vip-count">0</h3><p>Clientes VIP</p></div>
                </div>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h2>Base de Clientes</h2>
                    <input type="text" id="searchClient" placeholder="Pesquisar..." onkeyup="renderClients()" style="width:200px; margin:0">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Total Gasto</th>
                                <th>Status</th>
                                <th style="text-align:right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-products" class="view-section" style="display:none">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h2>Estoque de Produtos</h2>
                    <button class="btn-primary" onclick="openProductModal()"><i class="fas fa-plus"></i> Novo Produto</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Preço</th>
                                <th>Qtd</th>
                                <th style="text-align:right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-support" class="view-section" style="display:none">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem">
                    <h2>Chamados em Aberto</h2>
                    <button class="btn-primary" onclick="renderTickets()" style="font-size:0.8rem"><i class="fas fa-sync"></i> Atualizar</button>
                </div>
                <div id="tickets-list"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="client-modal">
        <div class="modal-box">
            <h3>Editar Cliente</h3>
            <input type="hidden" id="editIndex">
            <label>Nome</label><input type="text" id="editName">
            <label>Email</label><input type="email" id="editEmail">
            <label>Cargo</label>
            <select id="editRole">
                <option value="customer">Cliente</option>
                <option value="admin">Administrador</option>
            </select>
            <label>Status</label>
            <select id="editStatus">
                <option value="active">ATIVO</option>
                <option value="blocked">BLOQUEADO</option>
            </select>
            <div style="display:flex; gap:10px; justify-content:flex-end">
                <button class="btn-primary" onclick="saveClient()">Salvar</button>
                <button onclick="document.getElementById('client-modal').classList.remove('open')">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="product-modal">
        <div class="modal-box">
            <h3 id="prod-modal-title">Novo Produto</h3>
            <input type="hidden" id="prodIndex">
            <label>Nome</label><input type="text" id="pName">
            <label>Descrição Curta</label><textarea id="pDesc" rows="2"></textarea>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Preço</label><input type="number" id="pPrice" step="0.01"></div>
                <div style="flex:1"><label>Estoque</label><input type="number" id="pQty"></div>
            </div>
            <label>Categoria</label>
            <select id="pCat">
                <option>Fragrâncias & Body</option><option>Skin Care</option><option>Roupas</option><option>Maquiagem</option>
            </select>
            <label>URL Imagem</label><input type="text" id="pImg">
            <div style="display:flex; gap:10px; justify-content:flex-end">
                <button class="btn-primary" onclick="saveProduct()">Salvar</button>
                <button onclick="document.getElementById('product-modal').classList.remove('open')">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="chat-modal">
        <div class="modal-box" style="width:600px">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>Atendimento: <span id="chat-client-name"></span></h3>
                <span onclick="document.getElementById('chat-modal').classList.remove('open')" style="cursor:pointer">&times;</span>
            </div>
            
            <div class="chat-history" id="admin-chat-history"></div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="text" id="adminReplyInput" placeholder="Digite sua resposta..." style="margin:0">
                <button class="btn-primary" onclick="sendAdminReply()"><i class="fas fa-paper-plane"></i></button>
            </div>

            <div style="border-top:1px solid #eee; padding-top:15px">
                <label style="font-size:0.8rem; font-weight:bold; color:#666">Encerrar Chat</label>
                <div style="display:flex; gap:10px">
                    <select id="closeReason" style="margin:0">
                        <option value="Solucionado">Problema Solucionado</option>
                        <option value="Inatividade">Cliente não respondeu</option>
                        <option value="Transferido">Transferido</option>
                    </select>
                    <button class="btn-danger" onclick="confirmEndChat()">Encerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTicketId = null;

        // --- SISTEMA DE TOAST (NOTIFICAÇÕES) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';

            toast.innerHTML = `
                <i class="fas fa-${icon}" style="font-size:1.5rem; color:inherit"></i>
                <div class="toast-content">
                    <h4>${type === 'success' ? 'Sucesso' : type === 'error' ? 'Erro' : 'Aviso'}</h4>
                    <p>${message}</p>
                </div>
            `;
            
            container.appendChild(toast);

            // Remove após 3 segundos
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- NAVEGAÇÃO ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            document.getElementById('view-' + tab).style.display = 'block';
            document.getElementById('menu-' + tab).classList.add('active');
            if(tab === 'clients') renderClients();
            if(tab === 'products') renderStock();
            if(tab === 'support') renderTickets();
        }

        // --- CLIENTES ---
        function renderClients() {
            const users = JSON.parse(localStorage.getItem('auraUsers')) || [];
            const tbody = document.getElementById('clientsTableBody');
            const search = document.getElementById('searchClient').value.toLowerCase();
            tbody.innerHTML = '';
            let vips = 0;

            users.forEach((u, i) => {
                if(!u.name.toLowerCase().includes(search)) return;
                const isVip = u.spent > 500;
                if(isVip) vips++;
                
                tbody.innerHTML += `
                    <tr>
                        <td><b>${u.name}</b></td>
                        <td>${u.email}</td>
                        <td style="color:var(--success)"><b>R$ ${parseFloat(u.spent || 0).toFixed(2)}</b></td>
                        <td><span class="status-badge ${u.status === 'active' ? 'status-active' : 'status-blocked'}">${u.status}</span></td>
                        <td style="text-align:right">
                            <button class="btn-primary" style="padding:5px 10px" onclick="openClientEdit(${i})"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('count-clients').innerText = users.length;
            document.getElementById('vip-count').innerText = vips;
        }

        function openClientEdit(i) {
            const u = JSON.parse(localStorage.getItem('auraUsers'))[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('editName').value = u.name;
            document.getElementById('editEmail').value = u.email;
            document.getElementById('editRole').value = u.role || 'customer';
            document.getElementById('editStatus').value = u.status;
            document.getElementById('client-modal').classList.add('open');
        }

        function saveClient() {
            const i = document.getElementById('editIndex').value;
            let users = JSON.parse(localStorage.getItem('auraUsers'));
            users[i].name = document.getElementById('editName').value;
            users[i].email = document.getElementById('editEmail').value;
            users[i].role = document.getElementById('editRole').value;
            users[i].status = document.getElementById('editStatus').value;
            localStorage.setItem('auraUsers', JSON.stringify(users));
            document.getElementById('client-modal').classList.remove('open');
            showToast('Cliente atualizado com sucesso!', 'success');
            renderClients();
        }

        // --- ESTOQUE ---
        function renderStock() {
            const stock = JSON.parse(localStorage.getItem('auraStock')) || [];
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            stock.forEach((p, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${p.img}" class="product-thumb"></td>
                        <td><b>${p.name}</b></td>
                        <td>${p.category}</td>
                        <td>R$ ${p.price}</td>
                        <td><b style="color:${p.qty < 5 ? 'red' : 'inherit'}">${p.qty}</b></td>
                        <td style="text-align:right">
                            <button class="btn-primary" style="padding:5px 10px" onclick="openProductModal(${i})"><i class="fas fa-pen"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function openProductModal(i = null) {
            if(i !== null) {
                const p = JSON.parse(localStorage.getItem('auraStock'))[i];
                document.getElementById('prodIndex').value = i;
                document.getElementById('pName').value = p.name;
                document.getElementById('pDesc').value = p.description || '';
                document.getElementById('pPrice').value = p.price;
                document.getElementById('pQty').value = p.qty;
                document.getElementById('pCat').value = p.category;
                document.getElementById('pImg').value = p.img;
                document.getElementById('prod-modal-title').innerText = "Editar Produto";
            } else {
                document.getElementById('pName').value = '';
                document.getElementById('prodIndex').value = "";
                document.getElementById('prod-modal-title').innerText = "Novo Produto";
            }
            document.getElementById('product-modal').classList.add('open');
        }

        function saveProduct() {
            const i = document.getElementById('prodIndex').value;
            let stock = JSON.parse(localStorage.getItem('auraStock')) || [];
            const newP = {
                name: document.getElementById('pName').value,
                description: document.getElementById('pDesc').value,
                price: document.getElementById('pPrice').value,
                qty: document.getElementById('pQty').value,
                category: document.getElementById('pCat').value,
                img: document.getElementById('pImg').value
            };
            if(i === "") stock.push(newP); else stock[i] = newP;
            localStorage.setItem('auraStock', JSON.stringify(stock));
            document.getElementById('product-modal').classList.remove('open');
            showToast('Produto salvo no estoque!', 'success');
            renderStock();
        }

        // --- SUPORTE (MODIFICADO) ---
        
        // Função que roda a cada 3 segundos para buscar novas mensagens
        setInterval(() => {
            // Só atualiza se a aba de suporte estiver aberta ou para notificar badge
            checkNewMessages();
            if(document.getElementById('view-support').style.display === 'block') {
                renderTickets();
            }
        }, 3000);

        function checkNewMessages() {
            const tickets = JSON.parse(localStorage.getItem('auraTickets')) || [];
            const active = tickets.some(t => t.status === 'Pendente');
            document.getElementById('support-badge').style.display = active ? 'inline-block' : 'none';
        }

        function renderTickets() {
            const tickets = JSON.parse(localStorage.getItem('auraTickets')) || [];
            const list = document.getElementById('tickets-list');
            list.innerHTML = '';
            
            const activeTickets = tickets.filter(t => t.status !== 'Resolvido');
            
            if(activeTickets.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Nenhum chamado pendente.</p>';
                return;
            }

            activeTickets.forEach(t => {
                const lastMsg = t.messages[t.messages.length-1];
                list.innerHTML += `
                    <div class="ticket-item ${t.status === 'Pendente' ? 'new-msg' : ''}">
                        <div>
                            <div style="display:flex; align-items:center; gap:10px">
                                <b>${t.user}</b> 
                                <span class="status-badge ${t.status === 'Pendente' ? 'status-blocked' : 'status-active'}">${t.status}</span>
                            </div>
                            <p style="font-size:0.8rem; color:#666; margin-top:5px; max-width:500px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
                                <i class="fas fa-reply" style="transform:rotate(180deg)"></i> ${lastMsg.text}
                            </p>
                        </div>
                        <button class="btn-primary" onclick="openChatModal(${t.id})">Atender</button>
                    </div>`;
            });
        }

        function openChatModal(id) {
            currentTicketId = id;
            const tickets = JSON.parse(localStorage.getItem('auraTickets')) || [];
            const t = tickets.find(x => x.id === id);
            
            document.getElementById('chat-client-name').innerText = t.user;
            renderChatHistory(t);
            document.getElementById('chat-modal').classList.add('open');
        }

        function renderChatHistory(ticket) {
            const historyDiv = document.getElementById('admin-chat-history');
            historyDiv.innerHTML = '';
            ticket.messages.forEach(m => {
                let cssClass = 'client-msg';
                if(m.sender === 'Admin' || m.sender === 'Sistema') cssClass = 'admin-msg';
                if(m.sender === 'Sistema') cssClass = 'sys-msg';

                historyDiv.innerHTML += `
                    <div class="${cssClass}">
                        ${m.sender !== 'Sistema' ? `<b>${m.sender}</b><br>` : ''}
                        ${m.text}
                    </div>`;
            });
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        function sendAdminReply() {
            const txt = document.getElementById('adminReplyInput').value;
            if(!txt) return;

            let tickets = JSON.parse(localStorage.getItem('auraTickets')) || [];
            const tIndex = tickets.findIndex(x => x.id === currentTicketId);
            
            if(tIndex > -1) {
                tickets[tIndex].messages.push({
                    sender: 'Admin',
                    text: txt,
                    timestamp: Date.now()
                });
                tickets[tIndex].status = 'Respondido'; // Muda status para o cliente saber
                localStorage.setItem('auraTickets', JSON.stringify(tickets));
                
                document.getElementById('adminReplyInput').value = '';
                renderChatHistory(tickets[tIndex]);
            }
        }

        function confirmEndChat() {
            const reason = document.getElementById('closeReason').value;
            let tickets = JSON.parse(localStorage.getItem('auraTickets')) || [];
            const tIndex = tickets.findIndex(x => x.id === currentTicketId);

            if(tIndex > -1) {
                tickets[tIndex].status = 'Resolvido';
                tickets[tIndex].messages.push({ 
                    sender: 'Sistema', 
                    text: `Atendimento encerrado pelo suporte. Motivo: ${reason}`, 
                    timestamp: Date.now() 
                });
                localStorage.setItem('auraTickets', JSON.stringify(tickets));
                
                showToast('Atendimento encerrado.', 'success');
                document.getElementById('chat-modal').classList.remove('open');
                renderTickets();
            }
        }

        // Init
        renderClients();
        checkNewMessages();
    </script>
</body>
</html>
