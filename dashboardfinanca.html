<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Integrux | Central de Comando</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        if(!sessionStorage.getItem('integrux_session')) {
            window.location.href = 'index.html';
        }
    </script>

    <style>
        :root {
            /* --- TEMA ESCURO (PADR√ÉO) --- */
            --bg-body: #050505;
            --bg-panel: #0E0F11;
            --bg-card: #141619;
            --border-color: #2D333B;
            --primary: #2F81F7;
            --primary-glow: rgba(47, 129, 247, 0.4);
            --success: #238636;
            --danger: #F85149;
            --warning: #e3b341;
            --text-main: #E6EDF3;
            --text-muted: #7D8590;
            --card-shadow: none;
            --input-bg: #0d1117;
            --logo-fill: #FFFFFF;
            --nav-hover: rgba(255, 255, 255, 0.03);
            --nav-active-bg: rgba(47, 129, 247, 0.1);
            --blur-strength: 6px;
        }

        /* --- TEMA CLARO (INTEGRUX - CONCRETO) --- */
        body.light-mode {
            --bg-body: #e2e4e8;
            --bg-panel: #f1f5f9;
            --bg-card: #ffffff;
            --border-color: #cbd5e1;
            --primary: #2563eb;
            --primary-glow: rgba(37, 99, 235, 0.2);
            --success: #16a34a;
            --danger: #dc2626;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-shadow: 4px 4px 10px rgba(0,0,0,0.1), -4px -4px 10px rgba(255,255,255,0.8);
            --input-bg: #f8fafc;
            --logo-fill: #1e293b;
            --nav-hover: rgba(0, 0, 0, 0.05);
            --nav-active-bg: rgba(37, 99, 235, 0.1);
        }

        /* --- MODO PRIVACIDADE --- */
        body.privacy-mode .blur-sensitive {
            color: transparent !important;
            text-shadow: 0 0 var(--blur-strength) rgba(128, 128, 128, 0.5);
            user-select: none;
            cursor: default;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body); color: var(--text-main);
            display: flex; min-height: 100vh; overflow-x: hidden; font-size: 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- PULL TO REFRESH --- */
        #ptr-loader {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 50%; z-index: 999; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: top 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #ptr-spinner {
            width: 20px; height: 20px; border: 2px solid rgba(47, 129, 247, 0.3);
            border-top: 2px solid var(--primary); border-radius: 50%;
        }
        .ptr-spinning { animation: ptr-spin 0.8s linear infinite; }
        @keyframes ptr-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- SIDEBAR --- */
        aside {
            width: 260px; background-color: var(--bg-panel); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 25px 15px; padding-top: 40px;
            position: fixed; height: 100vh; z-index: 100; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
        }

        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 35px; padding-left: 5px; cursor: pointer; }
        .brand svg { width: 24px; height: 24px; fill: var(--logo-fill); filter: drop-shadow(0 0 10px var(--primary-glow)); transition: fill 0.3s; }
        .brand-text { font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; color: var(--text-main); }

        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .nav-item {
            padding: 10px 14px; border-radius: 8px; color: var(--text-muted);
            cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.9rem;
        }
        .nav-item:hover { background: var(--nav-hover); color: var(--text-main); }
        .nav-item.active { background: var(--nav-active-bg); color: var(--primary); border: 1px solid rgba(47, 129, 247, 0.2); }
        .nav-item svg { width: 18px; height: 18px; stroke-width: 2; }
        
        .btn-logout { margin-top: auto; color: var(--danger); padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; }
        .btn-logout:hover { background: rgba(248, 81, 73, 0.1); }

        /* --- MAIN CONTENT --- */
        main { margin-left: 260px; flex: 1; padding: 30px 40px; width: 100%; padding-top: 50px; transition: transform 0.2s; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; }
        .header-left h1 { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px; }
        .bio-quote { color: var(--text-muted); font-size: 0.85rem; font-style: italic; border-left: 3px solid var(--primary); padding-left: 10px; }

        .header-right { display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 8px; }

        .user-badge { 
            display: flex; align-items: center; gap: 10px; 
            background: var(--bg-card); padding: 4px 4px 4px 12px; 
            border-radius: 50px; border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow); 
        }
        .avatar-circle {
            width: 32px; height: 32px; background: var(--primary); color: #fff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem; box-shadow: 0 0 8px var(--primary-glow); border: 2px solid var(--bg-panel);
        }

        /* --- BOT√ïES DO TOPO (OLHO E TEMA) --- */
        .icon-btn {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--card-shadow); transition: all 0.3s; color: var(--text-main);
            min-width: 40px; min-height: 40px; padding: 8px;
        }
        .icon-btn:hover { transform: scale(1.05); }
        .icon-btn svg { width: 100%; height: 100%; fill: var(--logo-fill); }
        #privacyToggle svg { fill: none; stroke: var(--logo-fill); } /* O olho √© vazado (stroke) */
        #themeToggle svg { transform: translateY(1px); }

        /* --- VIEWS --- */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { 
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 18px; 
            border-radius: 12px; position: relative; transition: transform 0.2s, box-shadow 0.3s; 
            box-shadow: var(--card-shadow); overflow: hidden;
        }
        .card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .card-val { font-size: 1.6rem; font-weight: 700; font-family: 'JetBrains Mono'; color: var(--text-main); margin: 8px 0; }
        .card-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

        /* ESTILOS NOVOS: MOTO AZUL, FIESTA PRATA, DIVIDAS */
        .card-moto { border-left: 4px solid #0066FF; }
        .card-fiesta { border-left: 4px solid #C0C0C0; }
        .card-divida { border-left: 4px solid #F85149; }

        /* BARRA DE PROGRESSO */
        .progress-container { width: 100%; background: rgba(125,125,125,0.1); height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        /* CATEGORIA CHART (NOVO) */
        .cat-bar-container { margin-bottom: 8px; }
        .cat-bar-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .cat-bar-fill { height: 6px; border-radius: 3px; background: var(--primary); opacity: 0.7; }

        /* --- GR√ÅFICO E LISTAS --- */
        .chart-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: var(--card-shadow); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        
        .mini-status { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; background: rgba(255,255,255,0.03); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-color); }
        body.light-mode .mini-status { background: rgba(0,0,0,0.05); }
        .status-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 5px var(--success); }

        .total-year-widget { display: flex; align-items: center; background: rgba(47, 129, 247, 0.08); border: 1px solid rgba(47, 129, 247, 0.2); padding: 5px 15px; border-radius: 8px; margin-right: 10px; height: 36px; }
        .tyw-label { font-size: 0.7rem; color: var(--primary); text-transform: uppercase; margin-right: 8px; font-weight: 600; }
        .tyw-value { font-size: 0.95rem; color: var(--text-main); font-family: 'JetBrains Mono'; font-weight: 700; }

        .chart-container { height: 280px; width: 100%; overflow-x: auto; overflow-y: hidden; display: flex; align-items: flex-end; padding-bottom: 5px; }
        .chart-wrapper { display: flex; align-items: flex-end; gap: 12px; height: 100%; min-width: 100%; padding-right: 10px; }

        .chart-bar-group { flex: 1; min-width: 40px; max-width: 60px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; cursor: pointer; position: relative; transition: 0.2s; }
        .chart-val-top { font-size: 0.65rem; color: var(--text-main); margin-bottom: 4px; opacity: 0; transform: translateY(5px); transition: 0.2s; font-family: 'JetBrains Mono'; }
        .chart-bar-group:hover .chart-val-top { opacity: 1; transform: translateY(0); }
        .chart-bar-group:hover .chart-bar { opacity: 1; box-shadow: 0 0 10px var(--success); }
        .chart-bar { width: 100%; background: var(--success); opacity: 0.7; border-radius: 3px 3px 0 0; min-height: 4px; transition: height 0.5s ease; }
        .chart-label { margin-top: 6px; font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono'; text-align: center; }

        .table-responsive { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-card); box-shadow: var(--card-shadow); }
        .income-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .income-table th { text-align: left; color: var(--text-muted); padding: 10px 15px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
        .income-table td { padding: 10px 15px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; color: var(--text-main); }
        .badge-pago { background: rgba(35, 134, 54, 0.2); color: #238636; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; border: 1px solid rgba(35, 134, 54, 0.3); }

        .transaction-list { display: flex; flex-direction: column; gap: 8px; }
        .transaction-item { 
            background: var(--bg-card); border: 1px solid var(--border-color); 
            padding: 10px 14px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--card-shadow);
        }
        .t-icon { width: 32px; height: 32px; border-radius: 8px; background: rgba(125,125,125,0.1); display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; margin-right: 12px; }

        /* CONTROLES E INPUTS */
        .select-filter { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 10px; border-radius: 6px; cursor: pointer; outline: none; font-size: 0.85rem; height: 36px; }
        .input-dark { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.9rem; height: 40px; }
        
        /* BARRA DE BUSCA */
        .search-bar { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; color: var(--text-main); margin-bottom: 15px; font-size: 0.9rem; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 0.85rem; height: 38px; white-space: nowrap; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: rgba(248, 81, 73, 0.1); color: #f85149; }
        .btn-warning { background: rgba(227, 179, 65, 0.2); color: #e3b341; border: 1px solid rgba(227, 179, 65, 0.4); }
        .btn:active { transform: scale(0.96); }

        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 110; background: var(--bg-card); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; display: none; backdrop-filter: blur(4px); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
        .modal { background: var(--bg-card); width: 100%; max-width: 480px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }

        @media (max-width: 1100px) {
            aside { transform: translateX(-100%); box-shadow: 5px 0 30px rgba(0,0,0,0.5); }
            aside.open { transform: translateX(0); }
            main { margin-left: 0; padding: 70px 20px 40px 20px; }
            .mobile-toggle { display: block; }
            header { flex-direction: row; align-items: center; justify-content: space-between; }
            .header-left { margin-left: 50px; }
            .header-left h1 { font-size: 1.3rem; }
            .bio-quote, .user-info-text { display: none; }
            .income-table th:nth-child(4), .income-table td:nth-child(4),
            .income-table th:nth-child(5), .income-table td:nth-child(5) { display: none; }
            .tyw-label { display: none; } 
        }
    </style>
</head>
<body>

    <div id="ptr-loader"><div id="ptr-spinner"></div></div>

    <button class="mobile-toggle" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <aside id="mainSidebar">
        <div class="brand">
            <span class="brand-text">INTEGRUX</span>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchView('finance', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                Gest√£o de Gastos
            </div>
            <div class="nav-item" onclick="switchView('income', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                Minha Renda
            </div>
            <div class="nav-item" onclick="switchView('assets', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                Patrim√¥nio & D√≠vidas
            </div>
            <div class="nav-item" onclick="switchView('tools', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line></svg>
                Calculadora
            </div>
            <div class="nav-item" onclick="switchView('logs', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Logs & Backup
            </div>
        </nav>
        <div onclick="logout()" class="btn-logout">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sair
        </div>
    </aside>

    <main id="mainContent">
        <header>
            <div class="header-left">
                <h1>Painel Financeiro</h1>
                <p class="bio-quote">"Codando o futuro."</p>
            </div>
            <div class="header-right">
                <div class="header-actions">
                    <button id="privacyToggle" class="icon-btn" title="Modo Privacidade">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>

                    <button id="themeToggle" class="icon-btn" title="Alternar Tema">
                        <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="70 40 325 325" preserveAspectRatio="xMidYMid meet">
                            <g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)">
                                <path d="M1507 3963 c-4 -3 -7 -261 -7 -573 l0 -566 173 -152 c94 -83 195 -172 222 -196 l50 -45 126 -1 127 0 58 68 c32 37 78 87 101 112 23 25 54 61 68 80 14 18 31 37 37 42 7 4 -86 8 -207 8 l-220 0 -75 70 c-41 39 -90 82 -107 96 l-33 26 0 369 0 369 335 2 335 3 -33 35 c-18 19 -52 60 -76 90 -25 30 -49 60 -55 65 -6 6 -28 31 -49 58 l-38 47 -363 0 c-199 0 -366 -3 -369 -7z"></path>
                                <path d="M2416 3903 c32 -38 61 -70 64 -73 6 -5 262 -300 304 -350 40 -49 141 -165 146 -170 3 -3 22 -25 42 -50 l37 -46 -92 -105 c-95 -110 -446 -520 -530 -621 l-49 -58 200 0 199 0 99 117 c54 65 122 142 149 173 130 146 410 480 410 489 0 10 -29 45 -179 220 -54 64 -110 130 -124 146 -14 17 -53 62 -86 100 -34 39 -74 86 -90 105 -16 19 -60 70 -98 113 l-70 77 -195 0 -195 0 58 -67z"></path>
                                <path d="M3300 3564 c0 -3 44 -60 98 -125 53 -66 117 -144 141 -174 l43 -54 -146 -170 c-80 -94 -146 -173 -146 -176 0 -3 33 -5 74 -5 l74 0 154 168 c84 92 157 170 162 173 4 4 7 11 5 17 -2 5 -74 87 -159 181 l-155 171 -72 0 c-40 0 -73 -3 -73 -6z"></path>
                            </g>
                        </svg>
                    </button>
                </div>

                <div class="user-badge">
                    <div class="user-info-text" style="text-align: right; margin-right: 10px;">
                        <div id="userNameDisplay" style="font-size: 0.85rem; font-weight: 700;">Usu√°rio</div>
                        <div id="userRoleDisplay" style="font-size: 0.7rem; color: var(--primary);">Cargo</div>
                    </div>
                    <div id="userAvatarLetter" class="avatar-circle">A</div>
                </div>
            </div>
        </header>

        <section id="view-finance" class="view-section active-view">
            <div class="stats-grid">
                <div class="card" onclick="openMonthlyReport()" style="cursor: pointer;">
                    <div class="card-label">Sa√≠das (M√™s Selecionado)</div>
                    <div class="card-val blur-sensitive" style="color: var(--danger)" id="finTotal">R$ 0,00</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Toque para ver extrato</div>
                </div>
                <div class="card" style="border: 1px dashed var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="openAddTransaction()">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem;">+ Nova Despesa</div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px; padding: 15px;">
                <div style="font-size:0.85rem; margin-bottom:10px; color:var(--text-main); font-weight:600;">Top Categorias (M√™s)</div>
                <div id="categorySummary"></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>√öltimas Transa√ß√µes</h3>
                <input type="month" id="filterMonth" class="select-filter" onchange="renderFinance()">
            </div>
            
            <input type="text" id="financeSearch" class="search-bar" placeholder="üîç Buscar (Ex: gasolina, mercado)..." onkeyup="renderFinance()">
            
            <div class="transaction-list" id="transactionList"></div>
        </section>

        <section id="view-income" class="view-section">
            <div class="chart-section">
                <div class="chart-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h3 style="margin: 0; font-size:1.1rem;">Evolu√ß√£o L√≠quida</h3>
                        <div class="mini-status">
                            <div class="status-dot"></div>
                            <span style="color: var(--text-muted);">Cons√≥rcio Enolog</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="total-year-widget">
                            <span class="tyw-label">Total:</span>
                            <span class="tyw-value blur-sensitive" id="yearTotalDisplay">R$ 0,00</span>
                        </div>
                        <select id="incomeYearFilter" class="select-filter" onchange="renderIncome()" style="min-width: 80px;"></select>
                    </div>
                </div>
                <div class="chart-container"><div class="chart-wrapper" id="incomeChart"></div></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Hist√≥rico Completo</h3>
                <button class="btn btn-success" onclick="openAddIncome()">+ Adicionar Renda</button>
            </div>

            <div class="table-responsive">
                <table class="income-table">
                    <thead>
                        <tr><th>Data</th><th>Empresa</th><th>Cargo</th><th>Tipo</th><th>Bruto</th><th>L√≠quido</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody id="incomeTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="view-assets" class="view-section">
            <h3 style="margin-bottom: 20px;">Controle de Ve√≠culos</h3>
            <div class="stats-grid">
                <div class="card card-moto">
                    <div class="card-label">Passivo - Moto</div>
                    <div style="font-size: 1.1rem; font-weight: 700; color: #0066FF; margin: 5px 0;">Financiamento</div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                        <span id="motoStatus">Pagas: 4/59</span>
                        <span class="blur-sensitive">R$ 747,00/m√™s</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="motoBar" style="width: 6.7%; background-color: #0066FF;"></div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:15px; font-size:0.8rem;" onclick="Assets.payMoto()">Pagar Parcela Atual</button>
                </div>

                <div class="card card-fiesta">
                    <div class="card-label">Ativo - Fiesta 2003</div>
                    <div style="font-size: 1.1rem; font-weight: 700; color: #C0C0C0; margin: 5px 0;">A Receber</div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                        <span id="fiestaStatus">Restam: 5</span>
                        <span class="blur-sensitive">R$ 1.000,00/m√™s</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="fiestaBar" style="width: 16%; background-color: #C0C0C0;"></div>
                    </div>
                    <button class="btn btn-success" style="width:100%; margin-top:15px; font-size:0.8rem;" onclick="Assets.receiveFiesta()">Confirmar Recebimento</button>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Monitor de Empr√©stimos</h3>
            <div class="stats-grid">
                <div class="card card-divida">
                    <div class="card-label">UP.P (Finaliza Jan/26)</div>
                    <div class="card-val blur-sensitive" style="font-size:1.2rem;">R$ 303,85</div>
                    <div class="badge-pago" style="text-align:center; background: rgba(248, 81, 73, 0.2); color:#f85149; border-color:transparent;">Aten√ß√£o: M√™s Final</div>
                </div>
                <div class="card card-divida">
                    <div class="card-label">Agibank (Finaliza Jul/26)</div>
                    <div class="card-val blur-sensitive" style="font-size:1.2rem;">R$ 3.668,78</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Faltam 7 meses</div>
                </div>
                <div class="card card-divida">
                    <div class="card-label">Santander (Finaliza Ago/26)</div>
                    <div class="card-val blur-sensitive" style="font-size:1.2rem;">R$ 2.103,97</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Faltam 8 meses</div>
                </div>
            </div>
        </section>

        <section id="view-tools" class="view-section">
            <h3>Calculadora de Sal√°rio & Plant√£o</h3>
            <div class="card" style="margin-top: 20px;">
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                    <div>
                        <label style="color:var(--text-muted); font-size:0.85rem;">Sal√°rio Base Bruto</label>
                        <input type="text" class="input-dark" value="R$ 2.771,00" disabled style="opacity: 0.7;">
                    </div>
                    <div>
                        <label style="color:var(--text-muted); font-size:0.85rem;">Plant√µes (Fim de semana em casa)</label>
                        <select id="calcPlantoes" class="input-dark" onchange="calculateSalary()">
                            <option value="0">Nenhum (0)</option>
                            <option value="1">1 Plant√£o (R$ 100)</option>
                            <option value="2">2 Plant√µes (R$ 200)</option>
                            <option value="3">3 Plant√µes (R$ 300)</option>
                            <option value="4">4 Plant√µes (R$ 400)</option>
                        </select>
                    </div>
                    <div>
                        <label style="color:var(--text-muted); font-size:0.85rem;">Horas Extras (Estimativa R$)</label>
                        <input type="number" id="calcExtras" class="input-dark" placeholder="Ex: 150" onkeyup="calculateSalary()">
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px;">
                        <label style="color:var(--primary); font-size:0.9rem; font-weight:bold;">Estimativa Bruta Total</label>
                        <div id="calcResult" class="card-val blur-sensitive" style="color:var(--success);">R$ 2.771,00</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-logs" class="view-section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; flex-wrap: wrap; gap:10px;">
                <h3>Auditoria & Backup</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="System.backup()">‚¨áÔ∏è Backup (JSON)</button>
                    <input type="file" id="restoreFile" style="display:none;" onchange="System.restore(this)">
                    <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">‚¨ÜÔ∏è Restaurar</button>
                </div>
            </div>
            <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                 <button class="btn btn-primary" onclick="Logger.export()">üìÑ Exportar Texto</button>
                 <button class="btn btn-danger" onclick="Logger.clear()">Limpar Logs</button>
            </div>
            <div id="logsTerminal" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; display: flex; flex-direction: column; gap: 8px; max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
        </section>
    </main>

    <div class="modal-overlay" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Nova Despesa</h3>
                <button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('transactionModal')">X</button>
            </div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Descri√ß√£o</label>
                <input type="text" id="tDesc" class="input-dark" placeholder="Ex: Mercado Semanal">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Valor (R$)</label>
                        <input type="text" inputmode="decimal" id="tAmount" class="input-dark" placeholder="0,00">
                    </div>
                    <div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Categoria</label>
                        <select id="tCat" class="input-dark">
                            <option value="Aluguel">Aluguel</option><option value="Luz">Luz</option><option value="Agua">√Ågua</option>
                            <option value="Internet">Internet</option><option value="Vivo">Vivo</option><option value="Mercado">Mercado</option>
                            <option value="Fralda">Fralda</option><option value="Gasolina">Gasolina</option><option value="Banco">Banco</option>
                            <option value="Compras na Internet">Web</option><option value="Gastos por Fora">Outros</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 25px;" onclick="saveTransaction()">Salvar Transa√ß√£o</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="incomeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Nova Renda</h3>
                <button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('incomeModal')">X</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Data</label><input type="date" id="incDate" class="input-dark"></div>
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Empresa</label><input type="text" id="incCompany" class="input-dark" value="Cons√≥rcio Enolog"></div>
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Cargo</label><input type="text" id="incRole" class="input-dark" value="Inspetor de Saneamento I"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Bruto (R$)</label><input type="text" inputmode="decimal" id="incGross" class="input-dark" placeholder="0,00"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">L√≠quido (R$)</label><input type="text" inputmode="decimal" id="incNet" class="input-dark" placeholder="0,00"></div>
                </div>
                <div style="margin-top:10px;">
                    <label style="color:var(--text-muted); font-size:0.8rem;">Status</label>
                    <select id="incStatus" class="input-dark"><option>Pago</option><option>Pendente</option></select>
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 25px;" onclick="Income.save()">Registrar Renda</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Extrato Detalhado</h3>
                <button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('reportModal')">X</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="reportSummary" style="padding: 15px; background: var(--bg-panel); display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; border-bottom: 1px solid var(--border-color);"></div>
                <div id="reportContent" style="display: flex; flex-direction: column;"></div>
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = 'v12.0_Master_Complete';
        
        function parseMoneyInput(value) {
            if(!value) return 0;
            if(typeof value === 'number') return value;
            let clean = value.toString().replace(/[^\d.,]/g, '');
            if(clean.includes(',')) clean = clean.replace(/\./g, '').replace(',', '.');
            const floatVal = parseFloat(clean);
            return isNaN(floatVal) ? 0 : floatVal;
        }

        // --- PULL TO REFRESH LOGIC ---
        let startY = 0;
        let isPulling = false;
        const mainContent = document.getElementById('mainContent');
        const ptrLoader = document.getElementById('ptr-loader');
        const ptrSpinner = document.getElementById('ptr-spinner');

        window.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) { startY = e.touches[0].pageY; isPulling = true; }
        }, {passive: true});

        window.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            const y = e.touches[0].pageY;
            const diff = y - startY;
            if (diff > 0 && window.scrollY === 0) {
                const move = Math.min(diff * 0.4, 80);
                mainContent.style.transform = `translateY(${move}px)`;
                ptrLoader.style.top = `${move - 40}px`;
                ptrSpinner.style.transform = `rotate(${move * 5}deg)`;
            }
        }, {passive: true});

        window.addEventListener('touchend', () => {
            if (!isPulling) return;
            isPulling = false;
            const currentY = parseInt(mainContent.style.transform.replace(/[^0-9]/g, '') || 0);
            if (currentY > 60) {
                ptrLoader.style.top = '20px';
                ptrSpinner.classList.add('ptr-spinning');
                setTimeout(() => { location.reload(); }, 800);
            } else {
                mainContent.style.transform = '';
                ptrLoader.style.top = '-50px';
            }
        });

        // --- SISTEMA DE LOGS ---
        const Logger = {
            getLogs: () => JSON.parse(localStorage.getItem('integrux_logs')) || [],
            log: (action, desc) => {
                const session = JSON.parse(sessionStorage.getItem('integrux_session')) || { name: 'Desconhecido' };
                const now = new Date();
                const timeString = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
                const newLog = { id: Date.now(), time: timeString, user: session.name, action: action, desc: desc };
                const logs = Logger.getLogs();
                logs.unshift(newLog); 
                if(logs.length > 500) logs.pop(); 
                localStorage.setItem('integrux_logs', JSON.stringify(logs));
                if(document.getElementById('view-logs').classList.contains('active-view')) renderLogs();
            },
            clear: () => { if(confirm('Apagar logs?')) { localStorage.removeItem('integrux_logs'); renderLogs(); } },
            export: () => {
                const logs = Logger.getLogs();
                if(logs.length === 0) return alert('Sem logs.');
                let txt = "HIST√ìRICO INTEGRUX\n==================\n";
                logs.forEach(l => { txt += `[${l.time}] ${l.user} - ${l.action}: ${l.desc}\n`; });
                const blob = new Blob([txt], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Integrux_Logs.txt`; a.click();
            }
        };

        // --- GEST√ÉO DE ATIVOS E VE√çCULOS ---
        const Assets = {
            getData: () => JSON.parse(localStorage.getItem('integrux_assets')) || {
                moto: { paid: 4, total: 59, value: 747 },
                fiesta: { paid: 1, total: 6, value: 1000, remaining: 5 }
            },
            save: (data) => { localStorage.setItem('integrux_assets', JSON.stringify(data)); Assets.render(); },
            render: () => {
                const data = Assets.getData();
                // Moto
                document.getElementById('motoStatus').innerText = `Pagas: ${data.moto.paid}/${data.moto.total}`;
                const motoPct = (data.moto.paid / data.moto.total) * 100;
                document.getElementById('motoBar').style.width = `${motoPct}%`;
                
                // Fiesta
                document.getElementById('fiestaStatus').innerText = `Restam: ${data.fiesta.remaining}`;
                const fiestaPct = (data.fiesta.paid / data.fiesta.total) * 100;
                document.getElementById('fiestaBar').style.width = `${fiestaPct}%`;
            },
            payMoto: () => {
                if(!confirm('Pagar parcela da Moto deste m√™s (R$ 747)?')) return;
                const data = Assets.getData();
                if(data.moto.paid >= data.moto.total) return alert('Quitada!');
                
                data.moto.paid++;
                Assets.save(data);
                
                // Lan√ßa Despesa Automaticamente
                Finance.add('Parcela Moto', 747, 'Gastos por Fora');
                alert('Parcela paga e lan√ßada nas despesas!');
            },
            receiveFiesta: () => {
                if(!confirm('Recebeu R$ 1.000 do Fiesta?')) return;
                const data = Assets.getData();
                if(data.fiesta.remaining <= 0) return alert('Tudo recebido!');
                
                data.fiesta.remaining--;
                data.fiesta.paid++;
                Assets.save(data);
                
                // Lan√ßa Renda Automaticamente
                const today = new Date().toISOString().slice(0,10);
                const incData = Income.getData();
                incData.push({ id: Date.now(), date: today, company: 'Venda Ve√≠culo', role: 'Fiesta Prata', type: 'Venda', gross: 1000, net: 1000, status: 'Pago' });
                localStorage.setItem('integrux_income', JSON.stringify(incData));
                Logger.log('Recebimento', 'Parcela Fiesta - R$ 1.000,00');
                
                alert('Recebimento confirmado e lan√ßado na Renda!');
            }
        };

        // --- SISTEMA DE BACKUP TOTAL (JSON) ---
        const System = {
            backup: () => {
                const backup = {
                    income: JSON.parse(localStorage.getItem('integrux_income')),
                    finance: JSON.parse(localStorage.getItem('integrux_finance')),
                    logs: JSON.parse(localStorage.getItem('integrux_logs')),
                    assets: JSON.parse(localStorage.getItem('integrux_assets'))
                };
                const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Integrux_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            },
            restore: (input) => {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.income) localStorage.setItem('integrux_income', JSON.stringify(data.income));
                        if(data.finance) localStorage.setItem('integrux_finance', JSON.stringify(data.finance));
                        if(data.logs) localStorage.setItem('integrux_logs', JSON.stringify(data.logs));
                        if(data.assets) localStorage.setItem('integrux_assets', JSON.stringify(data.assets));
                        alert('Dados restaurados com sucesso!');
                        location.reload();
                    } catch(err) { alert('Erro no arquivo.'); }
                };
                reader.readAsText(file);
            }
        };

        // --- DADOS FINANCEIROS ---
        const Income = {
            getData: () => JSON.parse(localStorage.getItem('integrux_income')) || [],
            initDefaults: () => {
                if (!localStorage.getItem('integrux_income')) {
                    const defaults = [
                        { id: 40, date: '2025-07-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 2929.01, net: 2652.00, status: 'Pago' },
                        { id: 41, date: '2025-08-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 4041.90, net: 3495.38, status: 'Pago' },
                        { id: 42, date: '2025-09-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 3218.00, net: 2879.11, status: 'Pago' },
                        { id: 43, date: '2025-10-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 3086.34, net: 2780.32, status: 'Pago' },
                        { id: 44, date: '2025-11-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 3180.40, net: 2251.00, status: 'Pago' },
                        { id: 45, date: '2025-12-05', company: 'Cons√≥rcio Enolog', role: 'Inspetor de Saneamento I', type: 'Sal√°rio', gross: 3287.10, net: 2251.80, status: 'Pago' }
                    ];
                    localStorage.setItem('integrux_income', JSON.stringify(defaults));
                }
            },
            save: () => {
                const date = document.getElementById('incDate').value;
                const company = document.getElementById('incCompany').value;
                const role = document.getElementById('incRole').value;
                const grossInput = document.getElementById('incGross').value;
                const netInput = document.getElementById('incNet').value;
                const status = document.getElementById('incStatus').value;
                if (!date || !grossInput) return alert('Preencha os dados.');
                
                Logger.log('Nova Renda', `${company} (${role}) - L√≠quido: R$ ${netInput}`);
                const data = Income.getData();
                data.push({ id: Date.now(), date, company, role, type: 'Sal√°rio', gross: parseMoneyInput(grossInput), net: parseMoneyInput(netInput), status });
                data.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('integrux_income', JSON.stringify(data));
                renderIncome(); closeModal('incomeModal');
            },
            remove: (id) => {
                if(!confirm('Excluir?')) return;
                const item = Income.getData().find(i => i.id === id);
                if(item) Logger.log('Exclus√£o Renda', `${item.company} - R$ ${item.net}`);
                localStorage.setItem('integrux_income', JSON.stringify(Income.getData().filter(i => i.id !== id)));
                renderIncome();
            }
        };

        const Finance = {
            getData: () => JSON.parse(localStorage.getItem('integrux_finance')) || [],
            initDefaults: () => {
                if(!localStorage.getItem('integrux_finance')) {
                    const date2026 = '2026-01-05';
                    const defaults = [
                        { id: 1, date: date2026, desc: 'Aluguel Casa', amount: 650.00, cat: 'Aluguel' },
                        { id: 2, date: date2026, desc: 'Conta Luz', amount: 200.00, cat: 'Luz' },
                        { id: 3, date: date2026, desc: 'Internet', amount: 110.00, cat: 'Internet' },
                        { id: 4, date: date2026, desc: 'Parcela Moto (4/59)', amount: 747.00, cat: 'Gastos por Fora' }
                    ];
                    localStorage.setItem('integrux_finance', JSON.stringify(defaults));
                }
            },
            add: (desc, amountInput, cat) => {
                const val = parseMoneyInput(amountInput);
                if (!desc || val <= 0) return alert('Valor inv√°lido.');
                let saveDate = new Date().toISOString().slice(0,10);
                const currentFilter = document.getElementById('filterMonth').value;
                if (currentFilter) { 
                   const now = new Date();
                   const [fYear, fMonth] = currentFilter.split('-');
                   if (now.getMonth() + 1 == fMonth && now.getFullYear() == fYear) saveDate = now.toISOString().slice(0,10);
                   else saveDate = `${currentFilter}-01`;
                }
                Logger.log('Nova Despesa', `${desc} (${cat}) - R$ ${amountInput}`);
                const data = Finance.getData();
                data.unshift({ id: Date.now(), date: saveDate, desc, amount: val, cat });
                localStorage.setItem('integrux_finance', JSON.stringify(data));
                renderFinance(); closeModal('transactionModal');
            },
            remove: (id) => {
                const item = Finance.getData().find(i => i.id === id);
                if(item) Logger.log('Exclus√£o Despesa', `${item.desc} - R$ ${item.amount}`);
                localStorage.setItem('integrux_finance', JSON.stringify(Finance.getData().filter(i => i.id !== id)));
                renderFinance();
                if(document.getElementById('reportModal').style.display === 'flex') openMonthlyReport();
            }
        };

        // --- FERRAMENTAS ---
        function calculateSalary() {
            const base = 2771.00;
            const plantoes = parseInt(document.getElementById('calcPlantoes').value) * 100;
            const extras = parseFloat(document.getElementById('calcExtras').value) || 0;
            const total = base + plantoes + extras;
            document.getElementById('calcResult').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        // --- RENDERIZADORES ---
        function renderIncome() {
            const list = Income.getData();
            const yearFilter = document.getElementById('incomeYearFilter');
            const tbody = document.getElementById('incomeTableBody');
            const chart = document.getElementById('incomeChart');
            
            const years = [...new Set(list.map(i => i.date.split('-')[0]))].sort().reverse();
            const currentYear = years.includes('2026') ? '2026' : (years.length > 0 ? years[0] : new Date().getFullYear().toString());
            
            if (yearFilter.options.length !== years.length) {
                yearFilter.innerHTML = '';
                years.forEach(y => {
                    const opt = document.createElement('option'); opt.value = y; opt.innerText = y;
                    if(y === currentYear) opt.selected = true;
                    yearFilter.appendChild(opt);
                });
            }
            if(!yearFilter.value) yearFilter.value = currentYear;

            const filtered = list.filter(i => i.date.startsWith(yearFilter.value));
            const totalYear = filtered.reduce((acc, item) => acc + item.net, 0);
            document.getElementById('yearTotalDisplay').innerText = totalYear.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            tbody.innerHTML = '';
            filtered.forEach(i => {
                const d = i.date.split('-');
                tbody.innerHTML += `<tr><td style="color:var(--text-main);">${d[2]}/${d[1]}</td><td>${i.company}</td><td>${i.role}</td><td class="blur-sensitive">${i.type}</td><td class="blur-sensitive">${i.gross.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td><td class="blur-sensitive" style="color:var(--success)">${i.net.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td><td><span class="badge-pago">${i.status}</span></td><td><button class="btn" style="color:var(--danger); padding:0;" onclick="Income.remove(${i.id})">üóëÔ∏è</button></td></tr>`;
            });

            chart.innerHTML = '';
            const chartData = [...filtered].sort((a,b) => new Date(a.date) - new Date(b.date));
            if(chartData.length > 0) {
                const max = Math.max(...chartData.map(i => i.net));
                chartData.forEach(i => {
                    const h = max > 0 ? (i.net / max) * 100 : 0;
                    const d = i.date.split('-');
                    chart.innerHTML += `<div class="chart-bar-group"><div class="chart-val-top blur-sensitive">${i.net.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div><div class="chart-bar" style="height:${h}%;"></div><div class="chart-label">${d[2]}/${d[1]}</div></div>`;
                });
            } else { chart.innerHTML = '<div style="width:100%; text-align:center; color:var(--text-muted); padding-top:100px;">Sem dados.</div>'; }
        }

        function renderFinance() {
            const list = Finance.getData();
            const filter = document.getElementById('filterMonth').value;
            const search = document.getElementById('financeSearch').value.toLowerCase();
            const el = document.getElementById('transactionList');
            const catSummary = document.getElementById('categorySummary');
            el.innerHTML = '';
            
            let filtered = list;
            // Filtro por Busca (ignora data)
            if(search) {
                filtered = list.filter(i => i.desc.toLowerCase().includes(search) || i.cat.toLowerCase().includes(search));
            } else {
                // Filtro por Data
                filtered = list.filter(i => !filter || i.date.startsWith(filter));
            }

            if(filtered.length === 0) { 
                el.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Vazio.</div>'; 
                document.getElementById('finTotal').innerText = 'R$ 0,00'; 
                catSummary.innerHTML = '';
                return; 
            }

            // Exibi√ß√£o da Lista
            const displayList = search ? filtered : filtered.slice(0, 50);
            displayList.forEach(i => {
                const icon = getCategoryIcon(i.cat);
                el.innerHTML += `<div class="transaction-item"><div style="display:flex; align-items:center;"><div class="t-icon">${icon}</div><div><div style="font-weight:500; color:var(--text-main);">${i.desc}</div><div style="font-size:0.7rem; color:var(--text-muted);">${i.cat} - ${i.date}</div></div></div><div class="blur-sensitive" style="color:var(--danger); font-family:'JetBrains Mono'; font-weight:700;">- ${i.amount.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div></div>`;
            });

            // Totais e Gr√°fico de Categoria
            const total = filtered.reduce((a,b) => a + Number(b.amount), 0);
            document.getElementById('finTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            // L√≥gica simples para categorias (Top 3)
            if(!search) {
                const cats = {};
                filtered.forEach(i => { cats[i.cat] = (cats[i.cat] || 0) + i.amount; });
                const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]).slice(0, 3);
                catSummary.innerHTML = sortedCats.map(c => {
                    const pct = (c[1] / total) * 100;
                    return `<div class="cat-bar-container"><div class="cat-bar-header"><span>${c[0]}</span><span>${pct.toFixed(0)}%</span></div><div class="cat-bar-fill" style="width:${pct}%"></div></div>`;
                }).join('');
            } else {
                catSummary.innerHTML = '';
            }
        }

        function renderLogs() {
            const el = document.getElementById('logsTerminal');
            const logs = Logger.getLogs();
            if(logs.length === 0) { el.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">Vazio.</div>'; return; }
            el.innerHTML = logs.map(l => `<div style="padding:10px; background: rgba(0,0,0,0.2); border-left: 3px solid var(--primary); border-radius: 4px; margin-bottom: 5px;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--primary); font-weight:bold;">[${l.action}]</span><span style="color:var(--text-muted); font-size:0.7rem;">${l.time}</span></div><div style="color:var(--text-main);">${l.desc}</div><div style="color:var(--text-muted); font-size:0.7rem; margin-top:4px;">Usu√°rio: ${l.user}</div></div>`).join('');
        }

        function openMonthlyReport() {
            const filter = document.getElementById('filterMonth').value;
            const exps = Finance.getData().filter(i => !filter || i.date.startsWith(filter));
            const content = document.getElementById('reportContent');
            content.innerHTML = '';
            exps.forEach(i => {
                content.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border-color); color:var(--text-main);"><div>${i.desc}</div><div class="blur-sensitive" style="color:var(--danger)">- ${i.amount.toFixed(2)} <span onclick="Finance.remove(${i.id})" style="cursor:pointer; color:#777; margin-left:10px;">üóëÔ∏è</span></div></div>`;
            });
            document.getElementById('reportModal').style.display = 'flex';
        }

        function getCategoryIcon(cat) { const map = { 'Aluguel': 'üè†', 'Luz': 'üí°', 'Agua': 'üíß', 'Internet': 'üåê', 'Vivo': 'üì±', 'Fralda': 'üë∂', 'Gasolina': '‚õΩ', 'Banco': 'üè¶', 'Mercado': 'üõí', 'Compras na Internet': 'üõçÔ∏è' }; return map[cat] || 'üí∏'; }
        function switchView(v, el) { 
            document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active-view')); 
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active-view'); 
            if(el) el.classList.add('active'); 
            if(v==='income') renderIncome(); 
            if(v==='finance') renderFinance(); 
            if(v==='logs') renderLogs();
            if(v==='assets') Assets.render();
            if(window.innerWidth < 1100) toggleSidebar(); 
        }
        function toggleSidebar() { 
            const s = document.getElementById('mainSidebar'); 
            s.classList.toggle('open'); 
            document.getElementById('sidebarOverlay').style.display = s.classList.contains('open') ? 'block' : 'none'; 
        }
        function openAddTransaction() { document.getElementById('transactionModal').style.display = 'flex'; }
        function openAddIncome() { document.getElementById('incDate').value = new Date().toISOString().slice(0,10); document.getElementById('incomeModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logout() { if(confirm('Sair?')) { sessionStorage.removeItem('integrux_session'); window.location.href = 'index.html'; } }
        function saveTransaction() { Finance.add(document.getElementById('tDesc').value, document.getElementById('tAmount').value, document.getElementById('tCat').value); }

        window.onload = function() {
            const session = JSON.parse(sessionStorage.getItem('integrux_session'));
            if(session) {
                document.getElementById('userNameDisplay').innerText = session.name;
                document.getElementById('userRoleDisplay').innerText = session.role;
                document.getElementById('userAvatarLetter').innerText = session.initial;
            }
            
            // --- INICIALIZA√á√ÉO COM PRIVACIDADE ATIVADA POR PADR√ÉO ---
            document.body.classList.add('privacy-mode');

            // TEMA & PRIVACIDADE
            const toggleBtn = document.getElementById('themeToggle');
            const privacyBtn = document.getElementById('privacyToggle');
            const savedTheme = localStorage.getItem('integrux_theme');
            
            if (savedTheme === 'light') document.body.classList.add('light-mode');
            
            toggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                localStorage.setItem('integrux_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            });

            privacyBtn.addEventListener('click', () => {
                document.body.classList.toggle('privacy-mode');
            });

            Income.initDefaults(); Finance.initDefaults();
            document.getElementById('filterMonth').value = '2026-01';
            renderFinance();
        };
    </script>
</body>
</html>
